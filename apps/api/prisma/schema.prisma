// PaYa Database Schema
// P2P User-Owned Payment Network

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================== USERS ==================

model User {
  id           String   @id @default(uuid())
  username     String   @unique @db.VarChar(30)
  phoneHash    String   @unique @map("phone_hash") @db.VarChar(64)
  phoneLastFour String  @map("phone_last_four") @db.VarChar(4)
  
  // Synctera customer ID (for KYC and banking)
  syncteraCustomerId String? @unique @map("synctera_customer_id") @db.VarChar(100)
  syncteraAccountId  String? @unique @map("synctera_account_id") @db.VarChar(100)
  kycStatus          String? @map("kyc_status") @db.VarChar(20) // pending, verified, rejected
  
  status       String   @default("active") @db.VarChar(20) // active, frozen, suspended, deleted
  flags        Json     @default("[]") // ['fraud_review', 'reward_ineligible', 'new_account']
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  lastActiveAt DateTime? @map("last_active_at")

  // Relations
  wallet       Wallet?
  bankAccounts BankAccount[]
  sessions     Session[]
  
  sentTransactions     Transaction[] @relation("SentTransactions")
  receivedTransactions Transaction[] @relation("ReceivedTransactions")
  
  // Pending payments to non-users
  sentPendingPayments    PendingPayment[] @relation("SentPendingPayments")
  claimedPendingPayments PendingPayment[] @relation("ClaimedPendingPayments")
  
  weeklyActivity WeeklyActivity[]

  @@index([username])
  @@index([phoneHash])
  @@index([status])
  @@index([createdAt])
  @@index([syncteraCustomerId])
  @@map("users")
}

// ================== WALLETS ==================

model Wallet {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  
  balance       BigInt   @default(0) // Integer tokens (1 token = $1)
  totalLoaded   BigInt   @default(0) @map("total_loaded")
  totalSent     BigInt   @default(0) @map("total_sent")
  totalReceived BigInt   @default(0) @map("total_received")
  totalRedeemed BigInt   @default(0) @map("total_redeemed")
  totalRewards  BigInt   @default(0) @map("total_rewards")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  user          User     @relation(fields: [userId], references: [id])
  ledgerEntries LedgerEntry[]

  @@index([userId])
  @@map("wallets")
}

// ================== BANK ACCOUNTS ==================

model BankAccount {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  
  // Synctera external account reference
  syncteraExternalAccountId String? @unique @map("synctera_external_account_id") @db.VarChar(100)
  
  // Bank account details (from Synctera or manual entry)
  routingNumber    String?  @map("routing_number") @db.VarChar(9)
  accountNumberLast4 String? @map("account_number_last4") @db.VarChar(4)
  
  // Plaid integration (for instant bank linking)
  plaidAccessToken String?  @map("plaid_access_token") @db.Text
  plaidAccountId   String?  @map("plaid_account_id") @db.VarChar(100)
  plaidItemId      String?  @map("plaid_item_id") @db.VarChar(100)
  
  // Display info
  institutionName  String?  @map("institution_name") @db.VarChar(100)
  accountName      String?  @map("account_name") @db.VarChar(100)
  accountMask      String?  @map("account_mask") @db.VarChar(4)
  accountType      String?  @map("account_type") @db.VarChar(20) // checking, savings
  
  status           String   @default("pending") @db.VarChar(20) // pending, verification_pending, verified, failed, removed
  verifiedAt       DateTime? @map("verified_at")
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  removedAt        DateTime? @map("removed_at")

  // Relations
  user             User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([syncteraExternalAccountId])
  @@map("bank_accounts")
}

// ================== TRANSACTIONS ==================

model Transaction {
  id              String   @id @default(uuid())
  type            String   @db.VarChar(20) // load, payment, redemption, reward, fee, adjustment
  status          String   @default("pending") @db.VarChar(20) // pending, processing, completed, failed, cancelled
  
  fromUserId      String?  @map("from_user_id")
  toUserId        String?  @map("to_user_id")
  
  amount          BigInt   // Always positive
  feeAmount       BigInt   @default(0) @map("fee_amount")
  
  memo            String?  @db.VarChar(280)
  isPublic        Boolean  @default(true) @map("is_public")
  
  // External references
  externalId      String?  @map("external_id") @db.VarChar(100)
  externalStatus  String?  @map("external_status") @db.VarChar(50)
  
  metadata        Json     @default("{}")
  
  // Idempotency
  idempotencyKey  String?  @unique @map("idempotency_key") @db.VarChar(100)
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  completedAt     DateTime? @map("completed_at")

  // Relations
  fromUser        User?    @relation("SentTransactions", fields: [fromUserId], references: [id])
  toUser          User?    @relation("ReceivedTransactions", fields: [toUserId], references: [id])
  ledgerEntries   LedgerEntry[]

  @@index([fromUserId])
  @@index([toUserId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([externalId])
  @@index([isPublic, type, status, createdAt(sort: Desc)])
  @@map("transactions")
}

// ================== LEDGER ENTRIES ==================

model LedgerEntry {
  id            String   @id @default(uuid())
  transactionId String   @map("transaction_id")
  walletId      String   @map("wallet_id")
  
  entryType     String   @map("entry_type") @db.VarChar(10) // debit, credit
  amount        BigInt
  balanceAfter  BigInt   @map("balance_after")
  
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  wallet        Wallet      @relation(fields: [walletId], references: [id])

  @@index([transactionId])
  @@index([walletId])
  @@index([createdAt])
  @@map("ledger_entries")
}

// ================== SESSIONS ==================

model Session {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  
  tokenHash      String   @unique @map("token_hash") @db.VarChar(64)
  
  deviceId       String?  @map("device_id") @db.VarChar(100)
  deviceName     String?  @map("device_name") @db.VarChar(100)
  devicePlatform String?  @map("device_platform") @db.VarChar(20) // ios, android, web
  
  isActive       Boolean  @default(true) @map("is_active")
  
  createdAt      DateTime @default(now()) @map("created_at")
  lastUsedAt     DateTime @default(now()) @map("last_used_at")
  expiresAt      DateTime @map("expires_at")
  revokedAt      DateTime? @map("revoked_at")

  // Relations
  user           User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

// ================== WEEKLY CYCLES ==================

model WeeklyCycle {
  id              String   @id @default(uuid())
  
  weekNumber      Int      @unique @map("week_number") // e.g., 202448
  startsAt        DateTime @map("starts_at")
  endsAt          DateTime @map("ends_at")
  
  totalRevenue    BigInt   @default(0) @map("total_revenue") // In cents
  opsAllocation   BigInt   @default(0) @map("ops_allocation")
  userPool        BigInt   @default(0) @map("user_pool")
  remainder       BigInt   @default(0) // Carried to next week
  
  activeUserCount Int      @default(0) @map("active_user_count")
  perUserReward   BigInt   @default(0) @map("per_user_reward")
  
  status          String   @default("open") @db.VarChar(20) // open, calculating, distributed, finalized
  distributedAt   DateTime? @map("distributed_at")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([weekNumber])
  @@index([status])
  @@map("weekly_cycles")
}

// ================== WEEKLY ACTIVITY ==================

model WeeklyActivity {
  id                     String   @id @default(uuid())
  userId                 String   @map("user_id")
  weekNumber             Int      @map("week_number")
  
  publicPaymentsSent     Int      @default(0) @map("public_payments_sent")
  publicPaymentsReceived Int      @default(0) @map("public_payments_received")
  privatePaymentsSent    Int      @default(0) @map("private_payments_sent")
  
  isEligible             Boolean  @default(false) @map("is_eligible")
  
  rewardAmount           BigInt   @default(0) @map("reward_amount")
  rewardTxId             String?  @map("reward_tx_id")
  
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  // Relations
  user                   User     @relation(fields: [userId], references: [id])

  @@unique([userId, weekNumber])
  @@index([userId])
  @@index([weekNumber])
  @@index([isEligible])
  @@map("weekly_activity")
}

// ================== RESERVE SNAPSHOTS ==================

model ReserveSnapshot {
  id                     String   @id @default(uuid())
  
  reserveBalanceCents    BigInt   @map("reserve_balance_cents")
  totalTokensCirculation BigInt   @map("total_tokens_circulation")
  
  isBalanced             Boolean  @map("is_balanced")
  discrepancyCents       BigInt   @default(0) @map("discrepancy_cents")
  
  source                 String?  @db.VarChar(50) // daily_reconciliation, manual_audit
  
  createdAt              DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@map("reserve_snapshots")
}

// ================== AUDIT LOGS ==================

model AuditLog {
  id           String   @id @default(uuid())
  
  actorType    String   @map("actor_type") @db.VarChar(20) // user, admin, system
  actorId      String?  @map("actor_id")
  
  action       String   @db.VarChar(50) // account_freeze, balance_adjustment, etc.
  resourceType String?  @map("resource_type") @db.VarChar(50) // user, wallet, transaction
  resourceId   String?  @map("resource_id")
  
  details      Json     @default("{}")
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  userAgent    String?  @map("user_agent") @db.Text
  
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([actorId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ================== RATE LIMIT COUNTERS ==================

model RateLimitCounter {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  
  counterType String   @map("counter_type") @db.VarChar(50) // sends_hourly, sends_daily, etc.
  windowStart DateTime @map("window_start")
  
  count       Int      @default(0)

  @@unique([userId, counterType, windowStart])
  @@index([userId])
  @@index([windowStart])
  @@map("rate_limit_counters")
}

// ================== PENDING PAYMENTS (to non-users) ==================

model PendingPayment {
  id              String   @id @default(uuid())
  
  fromUserId      String   @map("from_user_id")
  toPhoneHash     String   @map("to_phone_hash") @db.VarChar(64)
  toPhoneLastFour String   @map("to_phone_last_four") @db.VarChar(4)
  
  amount          BigInt   // Amount in tokens
  memo            String?  @db.VarChar(280)
  isPublic        Boolean  @default(true) @map("is_public")
  
  status          String   @default("pending") @db.VarChar(20) // pending, claimed, expired, refunded
  
  // When the recipient signs up and claims
  claimedByUserId String?  @map("claimed_by_user_id")
  claimedAt       DateTime? @map("claimed_at")
  
  // Expiration (e.g., 30 days)
  expiresAt       DateTime @map("expires_at")
  
  // SMS invite tracking
  inviteSentAt    DateTime? @map("invite_sent_at")
  inviteCount     Int      @default(0) @map("invite_count")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  fromUser        User     @relation("SentPendingPayments", fields: [fromUserId], references: [id])
  claimedByUser   User?    @relation("ClaimedPendingPayments", fields: [claimedByUserId], references: [id])

  @@index([fromUserId])
  @@index([toPhoneHash])
  @@index([status])
  @@index([expiresAt])
  @@map("pending_payments")
}

